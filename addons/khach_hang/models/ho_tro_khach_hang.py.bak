# -*- coding: utf-8 -*-

from odoo import models, fields, api, _
from datetime import datetime


class HoTroKhachHang(models.Model):
    _name = 'ho_tro_khach_hang'
    _description = 'Hỗ trợ khách hàng'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'thoi_gian_bat_dau desc'

    # Thông tin cơ bản
    ten_yeu_cau = fields.Char('Tiêu đề yêu cầu', required=True, tracking=True)
    khach_hang_id = fields.Many2one('khach_hang', string='Khách hàng', required=True, 
                                     ondelete='cascade', tracking=True)
    mo_ta = fields.Text('Mô tả chi tiết')
    
    # Phương thức liên lạc
    phuong_thuc_lien_lac = fields.Selection([
        ('email', 'Email'),
        ('nhan_tin', 'Nhắn tin'),
        ('dien_thoai', 'Điện thoại'),
        ('truc_tiep', 'Trực tiếp')
    ], string='Phương thức liên lạc', required=True, default='email', tracking=True)
    
    # Thời gian
    thoi_gian_bat_dau = fields.Datetime('Thời gian bắt đầu', default=fields.Datetime.now, 
                                          required=True, tracking=True)
    thoi_gian_ket_thuc = fields.Datetime('Thời gian kết thúc', tracking=True)
    so_ngay_ho_tro = fields.Float('Số ngày hỗ trợ', compute='_compute_so_ngay_ho_tro', 
                                    store=True, help='Tính từ thời gian bắt đầu đến kết thúc')
    
    # Trạng thái
    trang_thai = fields.Selection([
        ('moi', 'Mới'),
        ('dang_xu_ly', 'Đang xử lý'),
        ('cho_phan_hoi', 'Chờ phản hồi'),
        ('da_giai_quyet', 'Đã giải quyết'),
        ('huy', 'Hủy')
    ], string='Trạng thái', default='moi', required=True, tracking=True)
    
    # Nhân viên
    nhan_vien_phu_trach_id = fields.Many2one('nhan_vien', string='Nhân viên phụ trách', 
                                               tracking=True)
    
    # Đánh giá
    diem_danh_gia = fields.Integer('Điểm đánh giá', help='Điểm đánh giá từ 1-5 sao',
                                     tracking=True)
    nhan_xet = fields.Text('Nhận xét từ khách hàng')
    
    # Màu sắc cho kanban/tree
    mau_sac = fields.Integer('Màu', compute='_compute_mau_sac')
    color = fields.Integer('Color', default=0)
    
    _sql_constraints = [
        ('check_diem_danh_gia', 'CHECK(diem_danh_gia >= 0 AND diem_danh_gia <= 5)', 
         'Điểm đánh giá phải từ 0 đến 5!')
    ]
    
    @api.depends('thoi_gian_bat_dau', 'thoi_gian_ket_thuc')
    def _compute_so_ngay_ho_tro(self):
        """Tính số ngày hỗ trợ"""
        for record in self:
            if record.thoi_gian_bat_dau and record.thoi_gian_ket_thuc:
                delta = record.thoi_gian_ket_thuc - record.thoi_gian_bat_dau
                record.so_ngay_ho_tro = delta.total_seconds() / 86400  # Chuyển sang ngày
            else:
                record.so_ngay_ho_tro = 0.0
    
    @api.depends('trang_thai', 'diem_danh_gia')
    def _compute_mau_sac(self):
        """Màu sắc theo trạng thái và đánh giá"""
        for record in self:
            if record.trang_thai == 'da_giai_quyet':
                if record.diem_danh_gia >= 4:
                    record.mau_sac = 10  # Xanh lá đậm
                elif record.diem_danh_gia >= 3:
                    record.mau_sac = 3  # Xanh lá nhạt
                else:
                    record.mau_sac = 1  # Xám
            elif record.trang_thai == 'dang_xu_ly':
                record.mau_sac = 4  # Xanh dương
            elif record.trang_thai == 'moi':
                record.mau_sac = 2  # Cam
            else:
                record.mau_sac = 0
    
    @api.onchange('khach_hang_id')
    def _onchange_khach_hang(self):
        """Tự động gán nhân viên phụ trách từ khách hàng"""
        if self.khach_hang_id and self.khach_hang_id.nhan_vien_phu_trach_id:
            self.nhan_vien_phu_trach_id = self.khach_hang_id.nhan_vien_phu_trach_id
    
    def action_bat_dau_xu_ly(self):
        """Bắt đầu xử lý yêu cầu"""
        for record in self:
            record.trang_thai = 'dang_xu_ly'
            if not record.thoi_gian_bat_dau:
                record.thoi_gian_bat_dau = fields.Datetime.now()
    
    def action_giai_quyet(self):
        """Đánh dấu đã giải quyết"""
        for record in self:
            record.trang_thai = 'da_giai_quyet'
            if not record.thoi_gian_ket_thuc:
                record.thoi_gian_ket_thuc = fields.Datetime.now()
    
    def action_huy(self):
        """Hủy yêu cầu"""
        for record in self:
            record.trang_thai = 'huy'
    
    @api.model
    def get_thong_ke_ho_tro(self):
        """Lấy thống kê hỗ trợ cho dashboard"""
        domain_da_giai_quyet = [('trang_thai', '=', 'da_giai_quyet')]
        
        tong_yeu_cau = self.search_count([])
        da_giai_quyet = self.search_count(domain_da_giai_quyet)
        
        # Thống kê theo nhân viên
        thong_ke_nhan_vien = self.env['nhan_vien'].search([]).mapped(lambda nv: {
            'nhan_vien': nv.ten_nv,
            'so_yeu_cau': self.search_count([('nhan_vien_phu_trach_id', '=', nv.id)]),
            'da_xu_ly': self.search_count([
                ('nhan_vien_phu_trach_id', '=', nv.id),
                ('trang_thai', '=', 'da_giai_quyet')
            ]),
            'diem_tb': 0.0  # Tính sau
        })
        
        return {
            'tong_yeu_cau': tong_yeu_cau,
            'da_giai_quyet': da_giai_quyet,
            'ty_le': (da_giai_quyet / tong_yeu_cau * 100) if tong_yeu_cau > 0 else 0,
            'thong_ke_nhan_vien': thong_ke_nhan_vien
        }
